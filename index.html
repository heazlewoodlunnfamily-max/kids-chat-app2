<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .pin-screen {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px 20px;
            text-align: center;
        }

        .pin-screen h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #333;
        }

        .pin-screen p {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
        }

        .pin-input {
            font-size: 24px;
            text-align: center;
            letter-spacing: 10px;
            padding: 15px;
            border: 3px solid #667eea;
            border-radius: 12px;
            margin-bottom: 20px;
            width: 100%;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .pin-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .pin-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .pin-btn {
            padding: 20px;
            font-size: 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pin-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .pin-btn:active {
            transform: scale(0.95);
        }

        .pin-btn.delete {
            background: #ff6b6b;
            grid-column: 1 / 2;
        }

        .pin-btn.delete:hover {
            background: #ff5252;
        }

        .pin-btn.submit {
            background: #4caf50;
            grid-column: 3 / 4;
        }

        .pin-btn.submit:hover {
            background: #45a049;
        }

        .pin-error {
            color: #ff5252;
            font-weight: bold;
            margin-bottom: 15px;
            min-height: 20px;
        }

        .login-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .login-btn {
            padding: 15px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .login-btn:active {
            transform: scale(0.95);
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 800px;
            display: none;
        }

        .container.show {
            display: flex;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            flex-grow: 1;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-dot.off {
            background: #ff5252;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            gap: 6px;
            padding: 10px;
            background: #f0f0f0;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 14px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 18px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .chat-display {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            word-wrap: break-word;
            font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.own .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.esther .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.valley .message-bubble {
            background: #ff6b9d;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.amaaya .message-bubble {
            background: #4ecdc4;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.mama .message-bubble {
            background: #95e1d3;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.mummy .message-bubble {
            background: #f38181;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.hilary .message-bubble {
            background: #aa96da;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.nan .message-bubble {
            background: #fcbad3;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.rishy .message-bubble {
            background: #ffd1b3;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.poppy .message-bubble {
            background: #a8e6cf;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.rodney .message-bubble {
            background: #ffd3a5;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message.millie .message-bubble {
            background: #c7ceea;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .speak-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: #ffc107;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .speak-btn:hover {
            background: #ffb300;
        }

        .speak-btn:active {
            transform: scale(0.95);
        }

        .message-sender {
            font-size: 12px;
            color: #999;
            margin: 4px 0;
            font-weight: 600;
        }

        .message.own .message-sender {
            text-align: right;
        }

        .input-area {
            padding: 12px;
            background: white;
            border-top: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            background: #fff3cd;
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #ffc107;
        }

        .emoji-option {
            font-size: 28px;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            user-select: none;
        }

        .emoji-option:hover {
            background: white;
            transform: scale(1.2);
        }

        .emoji-option:active {
            transform: scale(0.95);
        }

        .compose-area {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .compose-title {
            font-weight: bold;
            font-size: 13px;
            color: #333;
            margin-bottom: 8px;
        }

        .compose-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 8px;
        }

        .compose-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .compose-buttons {
            display: flex;
            gap: 8px;
        }

        .compose-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .compose-send {
            background: #667eea;
            color: white;
        }

        .compose-send:hover {
            background: #764ba2;
        }

        .compose-clear {
            background: #ccc;
            color: #333;
        }

        .compose-clear:hover {
            background: #bbb;
        }

        .compose-toggle-btn {
            background: #9c27b0;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 8px;
        }

        .compose-toggle-btn:hover {
            background: #7b1fa2;
            transform: scale(1.1);
        }

        .input-field {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #764ba2;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .emoji-toggle-btn {
            background: #fff;
            border: 2px solid #ffc107;
            color: #333;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .emoji-toggle-btn:hover {
            background: #ffc107;
            transform: scale(1.1);
        }

        .mic-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mic-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .mic-btn.listening {
            background: #ff9800;
            animation: micPulse 1s infinite;
        }

        @keyframes micPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .speaker-toggle {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .speaker-toggle:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .speaker-toggle.off {
            background: #999;
        }

        .empty {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            .message-bubble {
                max-width: 85%;
            }
            
            .input-field {
                font-size: 16px;
            }

            .emoji-picker {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="pin-screen" id="pinScreen">
        <h1>ğŸ” Enter PIN</h1>
        <p>Enter your 4-digit PIN</p>
        <div class="pin-error" id="pinError"></div>
        <input type="password" class="pin-input" id="pinInput" placeholder="â€¢â€¢â€¢" maxlength="4" inputmode="numeric">
        <div class="pin-buttons">
            <button class="pin-btn" onclick="addPin('1')">1</button>
            <button class="pin-btn" onclick="addPin('2')">2</button>
            <button class="pin-btn" onclick="addPin('3')">3</button>
            <button class="pin-btn" onclick="addPin('4')">4</button>
            <button class="pin-btn" onclick="addPin('5')">5</button>
            <button class="pin-btn" onclick="addPin('6')">6</button>
            <button class="pin-btn" onclick="addPin('7')">7</button>
            <button class="pin-btn" onclick="addPin('8')">8</button>
            <button class="pin-btn" onclick="addPin('9')">9</button>
            <button class="pin-btn delete" onclick="deletePin()">â†</button>
            <button class="pin-btn" onclick="addPin('0')">0</button>
            <button class="pin-btn submit" onclick="submitPin()">âœ“</button>
        </div>
    </div>

    <div class="login-screen" id="login" style="display: none;">
        <h1>ğŸ’¬ Chat</h1>
        <p>Who are you?</p>
        <div class="login-buttons">
            <button class="login-btn" onclick="login('esther')">Esther</button>
            <button class="login-btn" onclick="login('valley')">Valley</button>
            <button class="login-btn" onclick="login('amaaya')">Amaaya</button>
            <button class="login-btn" onclick="login('mama')">Mama</button>
            <button class="login-btn" onclick="login('mummy')">Mummy</button>
            <button class="login-btn" onclick="login('hilary')">Hilary</button>
            <button class="login-btn" onclick="login('nan')">Nan</button>
            <button class="login-btn" onclick="login('rishy')">Rishy</button>
            <button class="login-btn" onclick="login('poppy')">Poppy</button>
            <button class="login-btn" onclick="login('millie')">Millie</button>
        </div>
        <button class="logout-btn" onclick="logout()" style="margin-top: 20px; background: #ff6b6b; color: white; padding: 10px 20px;">Wrong PIN? Try Again</button>
    </div>

    <div class="container" id="app">
        <div class="header">
            <div class="header-title">ğŸ’¬ <span id="myname"></span></div>
            <div class="connection-status">
                <span class="status-dot" id="dot"></span>
                <span id="stat" style="font-size: 11px;">Online</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="tabs" id="tabs"></div>

        <div class="chat-display" id="chat">
            <div class="empty">Loading...</div>
        </div>

        <div class="input-area">
            <div id="emojiPicker" class="emoji-picker" style="display: none;"></div>
            
            <div id="composeArea" class="compose-area" style="display: none;">
                <div class="compose-title">âœï¸ Compose a Message</div>
                <textarea class="compose-textarea" id="composeText" placeholder="Write your message here..."></textarea>
                <div class="compose-buttons">
                    <button class="compose-btn compose-send" onclick="sendFromCompose()">Send Composed</button>
                    <button class="compose-btn compose-clear" onclick="clearCompose()">Clear</button>
                </div>
            </div>

            <div class="input-container">
                <button class="compose-toggle-btn" onclick="toggleCompose()" title="Compose message">âœï¸</button>
                <button class="emoji-toggle-btn" onclick="toggleEmojiPicker()" title="Add emoji">ğŸ˜€</button>
                <button class="mic-btn" id="micBtn" onclick="toggleVoiceInput()" title="Voice to Text">ğŸ¤</button>
                <button class="speaker-toggle" id="speakerBtn" onclick="toggleSpeaker()" title="Read messages aloud">ğŸ”Š</button>
                <input type="text" class="input-field" id="msg" placeholder="Type message..." disabled>
                <button class="send-btn" id="sendBtn" onclick="send()" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        const EMOJIS = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤—', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ™‚', 'ğŸ¤“', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤®', 'ğŸ¤¢', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ', 'ğŸ€', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸª', 'ğŸ©', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ•', 'ğŸ”', 'ğŸŸ', 'ğŸŒ­', 'ğŸ¿', 'â˜•', 'ğŸ§‹', 'ğŸ¥¤', 'ğŸ¹', 'ğŸ¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ¤²', 'ğŸ¤', 'ğŸ’…', 'ğŸ¨', 'ğŸ­', 'ğŸª', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¸', 'ğŸº', 'ğŸ·', 'ğŸ¥', 'ğŸ»', 'ğŸ²', 'ğŸ¯', 'ğŸ³', 'ğŸ®', 'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸš€', 'ğŸ›¸', 'ğŸŒŸ', 'â­', 'âœ¨', 'ğŸ’«', 'âš¡', 'â˜„ï¸', 'ğŸ’¥', 'ğŸ”¥', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'ğŸŒ¬ï¸', 'ğŸ’¨', 'ğŸ’§', 'ğŸ’¦', 'ğŸ±', 'ğŸ¶', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡'];

        // PIN Database - Change these PINs to whatever you want!
        const PINS = {
            '1111': 'esther',
            '2222': 'valley',
            '3333': 'amaaya',
            '4444': 'mama',
            '5555': 'mummy',
            '6666': 'hilary',
            '7777': 'nan',
            '8888': 'rishy',
            '9999': 'poppy',
            '1212': 'millie'
        };

        const USERS = {
            'esther': 'Esther',
            'valley': 'Valley',
            'amaaya': 'Amaaya',
            'mama': 'Mama',
            'mummy': 'Mummy',
            'hilary': 'Hilary',
            'nan': 'Nan',
            'rishy': 'Rishy',
            'poppy': 'Poppy',
            'millie': 'Millie'
        };

        let currentUser = null;
        let currentChat = 'group';
        let allChats = [];
        let messages = {};
        let ws = null;
        let connected = false;
        let showEmojiPicker = false;
        let recognition = null;
        let speakerEnabled = true;
        let showCompose = false;
        let drafts = {};
        let enteredPin = '';

        // PIN Functions
        function addPin(digit) {
            if (enteredPin.length < 4) {
                enteredPin += digit;
                document.getElementById('pinInput').value = 'â€¢'.repeat(enteredPin.length);
                document.getElementById('pinError').textContent = '';
            }
        }

        function deletePin() {
            enteredPin = enteredPin.slice(0, -1);
            document.getElementById('pinInput').value = 'â€¢'.repeat(enteredPin.length);
        }

        function submitPin() {
            if (enteredPin.length !== 4) {
                document.getElementById('pinError').textContent = 'Please enter 4 digits';
                return;
            }

            const user = PINS[enteredPin];
            if (user) {
                // PIN is correct
                document.getElementById('pinScreen').style.display = 'none';
                document.getElementById('login').style.display = 'block';
                enteredPin = '';
            } else {
                // Wrong PIN
                document.getElementById('pinError').textContent = 'âŒ Wrong PIN. Try again!';
                enteredPin = '';
                document.getElementById('pinInput').value = '';
            }
        }

        // Allow Enter key to submit PIN
        document.addEventListener('keypress', (e) => {
            if (document.getElementById('pinScreen').style.display !== 'none' && e.key === 'Enter') {
                submitPin();
            }
        });

        // Setup speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                document.getElementById('micBtn').classList.add('listening');
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('msg').value += transcript;
            };

            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('listening');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                document.getElementById('micBtn').classList.remove('listening');
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                alert('Voice input not supported on this device');
                return;
            }
            if (document.getElementById('micBtn').classList.contains('listening')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            const btn = document.getElementById('speakerBtn');
            if (speakerEnabled) {
                btn.classList.remove('off');
            } else {
                btn.classList.add('off');
                window.speechSynthesis.cancel();
            }
        }

        function speakMessage(text, user) {
            if (!speakerEnabled) return;
            
            const utterance = new SpeechSynthesisUtterance(USERS[user] + ' says: ' + text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            window.speechSynthesis.speak(utterance);
        }

        function getAvailableChats(user) {
            const chats = [];
            
            if (['esther', 'valley', 'amaaya'].includes(user)) {
                chats.push('group');
            }
            
            if (['mama', 'mummy', 'hilary'].includes(user)) {
                chats.push('group');
            }
            
            if (user === 'esther') {
                chats.push('esther-mama', 'esther-mummy', 'esther-hilary', 'esther-nan', 'esther-rishy', 'esther-poppy', 'esther-millie');
            } else if (['mama', 'mummy', 'hilary', 'nan', 'rishy', 'poppy', 'millie'].includes(user)) {
                chats.push('esther-' + user);
            }
            
            return chats;
        }

        function getChatName(chatId) {
            if (chatId === 'group') return 'ğŸ‘¥ Group Chat';
            const parts = chatId.split('-');
            const other = parts[0] === currentUser ? parts[1] : parts[0];
            return 'ğŸ’¬ ' + USERS[other];
        }

        function login(user) {
            currentUser = user;
            localStorage.setItem('user', user);
            
            allChats = getAvailableChats(user);
            currentChat = allChats[0];
            
            allChats.forEach(chat => {
                if (!messages[chat]) messages[chat] = [];
                // Load saved drafts
                const draft = localStorage.getItem('draft_' + chat);
                if (draft) {
                    drafts[chat] = draft;
                }
            });
            
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').classList.add('show');
            document.getElementById('myname').textContent = USERS[user];
            
            renderTabs();
            connect();
        }

        function logout() {
            localStorage.removeItem('user');
            // Reset to PIN screen
            document.getElementById('pinScreen').style.display = 'block';
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').classList.remove('show');
            enteredPin = '';
            document.getElementById('pinInput').value = '';
            document.getElementById('pinError').textContent = '';
        }

        function connect() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(proto + '//' + location.host);
            
            ws.onopen = () => {
                connected = true;
                updateStatus();
                document.getElementById('msg').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            };
            
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'load_messages') {
                    messages = data.messages;
                    render();
                } else if (data.type === 'message') {
                    const chatId = data.data.chatId;
                    if (!messages[chatId]) messages[chatId] = [];
                    messages[chatId].push(data.data);
                    if (chatId === currentChat) {
                        render();
                        if (speakerEnabled) {
                            speakMessage(data.data.text, data.data.user);
                        }
                    }
                }
            };
            
            ws.onclose = () => {
                connected = false;
                updateStatus();
                setTimeout(connect, 3000);
            };
        }

        function updateStatus() {
            const dot = document.getElementById('dot');
            if (connected) {
                dot.classList.remove('off');
                document.getElementById('stat').textContent = 'Online';
            } else {
                dot.classList.add('off');
                document.getElementById('stat').textContent = 'Offline';
            }
        }

        function renderTabs() {
            const div = document.getElementById('tabs');
            div.innerHTML = '';
            
            allChats.forEach(chatId => {
                const btn = document.createElement('button');
                btn.className = 'tab' + (chatId === currentChat ? ' active' : '');
                btn.textContent = getChatName(chatId);
                btn.onclick = () => {
                    currentChat = chatId;
                    renderTabs();
                    render();
                    showEmojiPicker = false;
                    document.getElementById('emojiPicker').style.display = 'none';
                    
                    // Load draft for this chat if it exists
                    const draft = localStorage.getItem('draft_' + chatId);
                    if (draft && showCompose) {
                        document.getElementById('composeText').value = draft;
                        drafts[chatId] = draft;
                    }
                };
                div.appendChild(btn);
            });
        }

        function renderEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.innerHTML = '';
            EMOJIS.forEach(emoji => {
                const btn = document.createElement('div');
                btn.className = 'emoji-option';
                btn.textContent = emoji;
                btn.onclick = () => {
                    const inp = document.getElementById('msg');
                    inp.value += emoji;
                    inp.focus();
                };
                picker.appendChild(btn);
            });
        }

        function toggleEmojiPicker() {
            showEmojiPicker = !showEmojiPicker;
            document.getElementById('emojiPicker').style.display = showEmojiPicker ? 'grid' : 'none';
        }

        function send() {
            const inp = document.getElementById('msg');
            const text = inp.value.trim();
            if (!text || !connected) return;
            
            const msg = {
                type: 'new_message',
                user: currentUser,
                chatId: currentChat,
                text: text
            };
            ws.send(JSON.stringify(msg));
            inp.value = '';
            showEmojiPicker = false;
            document.getElementById('emojiPicker').style.display = 'none';
        }

        function render() {
            const div = document.getElementById('chat');
            div.innerHTML = '';
            
            const msgs = messages[currentChat] || [];
            if (msgs.length === 0) {
                div.innerHTML = '<div class="empty">No messages yet. Start chatting! ğŸ’¬</div>';
                return;
            }
            
            msgs.forEach(m => {
                const d = document.createElement('div');
                d.className = 'message ' + (m.user === currentUser ? 'own' : m.user);
                const speakBtn = `<button class="speak-btn" onclick="speakMessage('${m.text.replace(/'/g, "\\'")}', '${m.user}')">ğŸ”Š Read</button>`;
                d.innerHTML = '<div class="message-sender">' + USERS[m.user] + '</div><div class="message-bubble">' + m.text + speakBtn + '</div>';
                div.appendChild(d);
            });
            
            div.scrollTop = div.scrollHeight;
        }

        document.getElementById('msg').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send();
        });

        function toggleCompose() {
            showCompose = !showCompose;
            document.getElementById('composeArea').style.display = showCompose ? 'block' : 'none';
            if (showCompose) {
                document.getElementById('composeText').focus();
                // Load existing draft if any
                if (drafts[currentChat]) {
                    document.getElementById('composeText').value = drafts[currentChat];
                }
            }
        }

        function sendFromCompose() {
            const text = document.getElementById('composeText').value.trim();
            if (!text || !connected) return;
            
            const msg = {
                type: 'new_message',
                user: currentUser,
                chatId: currentChat,
                text: text
            };
            ws.send(JSON.stringify(msg));
            
            // Clear and close compose
            document.getElementById('composeText').value = '';
            delete drafts[currentChat];
            showCompose = false;
            document.getElementById('composeArea').style.display = 'none';
            
            // Also clear from localStorage
            localStorage.removeItem('draft_' + currentChat);
        }

        function clearCompose() {
            document.getElementById('composeText').value = '';
            delete drafts[currentChat];
            localStorage.removeItem('draft_' + currentChat);
        }

        // Save drafts to localStorage
        document.addEventListener('input', (e) => {
            if (e.target.id === 'composeText') {
                const text = e.target.value;
                drafts[currentChat] = text;
                if (text) {
                    localStorage.setItem('draft_' + currentChat, text);
                } else {
                    localStorage.removeItem('draft_' + currentChat);
                }
            }
        });

        renderEmojiPicker();

        const savedUser = localStorage.getItem('user');
        if (savedUser) {
            login(savedUser);
        }
    </script>
</body>
</html>
